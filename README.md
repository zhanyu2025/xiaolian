# 🎙️ 小练 - 实时语音AI助手

小练是一个采用现代化 Python 工具链和清晰架构构建的实时语音AI助手项目。

## 🚀 快速开始

请确保你的系统已经安装了 **Python (>=3.10)**, **Docker** 和 **uv**。

### 1. 克隆仓库

```bash
git clone <your-repository-url>
cd xiaolian
```

### 2. 配置环境变量

`server` 应用需要 API 密钥等敏感信息。请在项目根目录创建一个 `.env` 文件，并填入必要的配置。

```bash
# 在项目根目录，拷贝示例文件
cp .env.example .env
```

然后，编辑 `.env` 文件并填入你的 `OPENAI_API_KEY`。

### 3. 启动开发环境

我们使用 `make` 命令来简化所有常用操作。只需一个命令，即可启动完整的开发环境：

```bash
make dev
```

该命令会自动完成以下所有工作：
1.  创建本地 Python 虚拟环境 (`.venv`)。
2.  使用 `uv sync` 安装 `server` 和 `cli` 的所有依赖。
3.  使用 `docker-compose` 构建并以后台模式启动 `server` 容器。

当看到 `✅ 开发环境已就绪！` 的提示时，代表服务端已在运行。

## 架构概览

以下流程图展示了客户端与服务端之间的实时数据流，以及系统内部“接收识别”与“思考回复”两个核心流水线之间的交互和打断机制。

```
[ 客户端 ]                                                                       [ 服务端 ]
    │                                                                                │
    │   [用户音频流]  =====================> │                                   │
    │                                        │      【流水线：接收与识别】
    │                                        │
    │                                        │   [WebSocket] -> [VAD] -> [ASR]
    │                                        │      (接收)    (检测)   (识别)
    │                                        │                      |
    │<---------------------------------------+---- [用户说话] ----> X (打断并取消任务)
    │                                        │                      |
    │                                        │                      v (识别出完整句子)
    │                                        │                    [文本]
    │                                        │                      |
    │                                        │                      +---- (触发) ----+
    │                                        │                                    |
    │                                        │                                    v
    │<==================== [TTS音频流] <===== │      【流水线：思考与回复】          |
    │                                        │                                    |
    │                                        │   [WebSocket] <- [TTS] <- [LLM] <--(使用文本)
    │                                        │      (发送)    (合成)   (回复)
    │                                                                                │
```

## 工作流与核心命令

所有常用操作都已封装在根目录的 `Makefile` 中。

| 命令 | 描述 |
| :--- | :--- |
| `make dev` | **(推荐)** 一键设置并启动完整的开发环境。 |
| `make logs` | 实时跟踪服务端 Docker 容器的日志。 |
| `make client` | 启动 TUI 客户端，与服务端进行语音交互。 |
| `make down` | 停止并移除所有服务容器。 |
| `make test` | 在正在运行的服务端容器内，执行 ASR 模型加载测试。 |
| `make install` | 在本地同步/安装所有 `apps` 的依赖到根 `.venv` 中。 |
| `make build` | 强制重新构建并启动服务容器。 |
| `make clean` | **(危险)** 彻底清理项目，包括 Docker 容器、卷、镜像和本地产物。|

## 📂 项目结构

```
.
├── apps/                  # 包含所有可独立部署的应用
│   ├── cli/               # TUI 客户端应用 ([详细文档](./apps/cli/README.md))
│   └── server/            # FastAPI 服务端应用 ([详细文档](./apps/server/README.md))
├── .dockerignore          # 优化 Docker 构建上下文
├── .env.example           # 环境变量示例文件
├── docker-compose.yml     # 生产环境 Docker 编排 (基础)
├── docker-compose.override.yml # 开发环境 Docker 编排 (覆盖)
├── Makefile               # 项目统一管理命令
└── pyproject.toml         # 项目工作区定义及全局开发工具配置
```

## 工程实践原则

*   **独立应用 (`apps`)**: 项目被组织为多个独立的应用（位于 `apps/` 目录），每个应用都拥有自己的 `pyproject.toml` 文件来管理依赖。
*   **集中式工具链**: 代码质量工具（如 `Ruff` 和 `Pyright`）在根目录进行集中配置，以确保整个项目代码风格的一致性。
*   **环境分离**: 通过多阶段 `Dockerfile` 和 `docker-compose.override.yml` 将开发与生产环境清晰分离。开发环境启用代码热重载，而生产环境构建的是精简、安全的不可变镜像。
*   **代码与数据分离**: 大型文件（如AI模型）不被打包进 Docker 镜像，而是通过卷挂载的方式提供给容器，以保持镜像的轻量和构建的高效。

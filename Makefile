# å°ç»ƒ - é¡¹ç›®ç®¡ç†æ–‡ä»¶
# ä¸ºé¡¹ç›®æä¾›é›†ä¸­ã€ç®€åŒ–çš„å‘½ä»¤ç®¡ç†ã€‚

SHELL := /bin/bash
VENV_DIR := .venv

.PHONY: help dev venv lock install up down build logs test client format clean

# ==============================================================================
#                          ä¸»è¦å¼€å‘å‘½ä»¤
# ==============================================================================

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘                      ğŸ™ï¸  å°ç»ƒ - Makefile                         â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ç”¨æ³•: make [å‘½ä»¤]"
	@echo ""
	@echo "--- æ ¸å¿ƒå¼€å‘å·¥ä½œæµ ---"
	@echo "  dev                - (æ¨è) ä¸€é”®è®¾ç½®å¹¶å¯åŠ¨å¼€å‘ç¯å¢ƒ (è‡ªåŠ¨æ›´æ–°é”æ–‡ä»¶)ã€‚"
	@echo "  client             - (å¸¸ç”¨) å¯åŠ¨ TUI å®¢æˆ·ç«¯ã€‚"
	@echo "  down               - åœæ­¢å¹¶ç§»é™¤æ‰€æœ‰æœåŠ¡å®¹å™¨ã€‚"
	@echo ""
	@echo "--- ç¯å¢ƒä¸ä¾èµ–ç®¡ç† ---"
	@echo "  lock               - (é‡è¦) ä¸ºæ‰€æœ‰åº”ç”¨æ›´æ–°/ç”Ÿæˆç»Ÿä¸€çš„é”æ–‡ä»¶ã€‚"
	@echo "  install            - åœ¨æœ¬åœ°åŒæ­¥/å®‰è£…æ‰€æœ‰åº”ç”¨çš„ä¾èµ–åˆ°æ ¹ .venv ä¸­ã€‚"
	@echo ""
	@echo "--- æœåŠ¡ç®¡ç†ä¸æµ‹è¯• ---"
	@echo "  up                 - (åå°) å¯åŠ¨æœåŠ¡å®¹å™¨ (ä¸é‡æ–°æ„å»ºæˆ–æ›´æ–°é”)ã€‚"
	@echo "  build              - å¼ºåˆ¶é‡æ–°æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ (è‡ªåŠ¨æ›´æ–°é”æ–‡ä»¶)ã€‚"
	@echo "  logs               - å®æ—¶è·Ÿè¸ªæœåŠ¡ç«¯æ—¥å¿—ã€‚"
	@echo "  test               - åœ¨æœåŠ¡ç«¯å®¹å™¨å†…è¿è¡Œ ASR æ¨¡å‹åŠ è½½æµ‹è¯•ã€‚"
	@echo ""
	@echo "--- å…¶ä»–å‘½ä»¤ ---"
	@echo "  format             - ä½¿ç”¨ Ruff æ ¼å¼åŒ–æ‰€æœ‰ä»£ç ã€‚"
	@echo "  clean              - (å±é™©) å½»åº•æ¸…ç†é¡¹ç›®ï¼ŒåŒ…æ‹¬ .venvã€Docker èµ„æºå’Œæ‰€æœ‰æ„å»ºäº§ç‰©ã€‚"
	@echo ""

dev: venv install build
	@echo ""
	@echo "âœ… å¼€å‘ç¯å¢ƒå·²å°±ç»ªï¼"
	@echo "   - æœåŠ¡ç«¯å·²åœ¨åå°è¿è¡Œã€‚"
	@echo "   - è¯·è¿è¡Œ 'make client' æ¥å¯åŠ¨ TUI å®¢æˆ·ç«¯ã€‚"
	@echo "   - è¯·è¿è¡Œ 'make logs' æ¥æŸ¥çœ‹æœåŠ¡ç«¯æ—¥å¿—ã€‚"
	@echo "   - è¯·è¿è¡Œ 'make down' æ¥åœæ­¢æœåŠ¡ç«¯ã€‚"

# ==============================================================================
#                          å­å‘½ä»¤å®ç°
# ==============================================================================

venv:
	@if [ ! -d "$(VENV_DIR)" ]; then \
		echo ">>> æ­£åœ¨åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒ..."; \
		uv venv; \
	fi

lock:
	@echo ">>> æ­£åœ¨æ£€æŸ¥å¹¶æ›´æ–° uv.lock..."
	uv lock

install: venv lock
	@echo ">>> æ­£åœ¨åŒæ­¥å¼€å‘ç¯å¢ƒä¾èµ– (å·¥ä½œåŒºæ¨¡å¼)..."
	uv sync

up:
	@echo ">>> æ­£åœ¨ä»¥åˆ†ç¦»æ¨¡å¼å¯åŠ¨æœåŠ¡ç«¯å®¹å™¨..."
	docker-compose up -d

down:
	@echo ">>> æ­£åœ¨åœæ­¢å¹¶ç§»é™¤æœåŠ¡ç«¯å®¹å™¨..."
	docker-compose down --remove-orphans

build: lock
	@echo ">>> æ­£åœ¨é‡æ–°æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ç«¯å®¹å™¨..."
	docker-compose up --build -d

logs:
	@echo ">>> æ­£åœ¨è·Ÿè¸ªæœåŠ¡ç«¯æ—¥å¿— (æŒ‰ Ctrl+C åœæ­¢)..."
	docker-compose logs -f

test:
	@echo ">>> æ­£åœ¨æœåŠ¡ç«¯å®¹å™¨å†…è¿è¡Œ ASR åŠ è¼‰æµ‹è¯•..."
	@echo "    å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å·²é€šè¿‡ 'make dev' å¯åŠ¨ã€‚"
	docker-compose exec server python tests/test_asr_load.py

# åœ¨ apps/cli ç›®å½•ä¸‹è¿è¡Œå‘½ä»¤ï¼Œä»¥åˆ›å»ºç‹¬ç«‹çš„ä¸Šä¸‹æ–‡å¹¶é¿å…å‘½åå†²çªã€‚
client: install
	@echo ">>> æ­£åœ¨å¯åŠ¨ TUI å®¢æˆ·ç«¯..."
	(cd apps/cli && uv run python -m app.main)

format:
	@echo ">>> æ­£åœ¨ä½¿ç”¨ Ruff æ ¼å¼åŒ–æ‰€æœ‰ä»£ç ..."
	uv run ruff format .

clean:
	@echo ">>> æ­£åœ¨å½»åº•æ¸…ç†é¡¹ç›®ç¯å¢ƒ..."
	@echo "    - åœæ­¢å¹¶ç§»é™¤ Docker å®¹å™¨ã€å·å’Œé•œåƒ..."
	docker-compose down --rmi all -v --remove-orphans
	@echo "    - æ¸…ç†æœ¬åœ°æ–‡ä»¶äº§ç‰©..."
	rm -rf .venv
	rm -f uv.lock
	find . -type f -name '*.pyc' -delete
	find . -type d -name '__pycache__' -exec rm -rf {} +
	find . -type d -name '*.egg-info' -exec rm -rf {} +
	rm -rf apps/cli/recordings apps/server/recordings
	find apps -name "uv.lock" -delete
	@echo "âœ… æ¸…ç†å®Œæˆï¼é¡¹ç›®å·²æ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚"

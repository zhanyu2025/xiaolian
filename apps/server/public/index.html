<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>Â∞èÁªÉËØ≠Èü≥Âä©Êâã (Web ÂÆ¢Êà∑Á´Ø - PCM)</title>
        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
                margin: 0;
                background-color: #f4f4f9;
            }
            .container {
                border-radius: 12px;
                padding: 40px;
                width: 90%;
                max-width: 500px;
                background-color: #fff;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
            button {
                font-size: 1.2rem;
                padding: 12px 25px;
                margin: 10px;
                cursor: pointer;
                border-radius: 8px;
                border: 1px solid #ccc;
                transition: background-color 0.2s;
            }
            button:disabled {
                cursor: not-allowed;
                opacity: 0.6;
            }
            #startBtn {
                background-color: #28a745;
                color: white;
            }
            #stopBtn {
                background-color: #dc3545;
                color: white;
            }
            #status {
                margin-top: 25px;
                font-size: 1.1rem;
                font-weight: bold;
                color: #555;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üé§ Â∞èÁªÉËØ≠Èü≥Âä©Êâã üé§</h1>
            <div class="controls">
                <button id="startBtn">ÂºÄÂßãÂΩïÈü≥</button>
                <button id="stopBtn" disabled>ÂÅúÊ≠¢ÂΩïÈü≥</button>
            </div>
            <div id="status">Áä∂ÊÄÅ: Á©∫Èó≤</div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const startBtn = document.getElementById("startBtn");
                const stopBtn = document.getElementById("stopBtn");
                const statusDiv = document.getElementById("status");

                let websocket;
                let audioContext;
                let audioStream;
                let audioWorkletNode;

                const log = (msg) => {
                    statusDiv.textContent = `Áä∂ÊÄÅ: ${msg}`;
                    console.log(`[ÂÆ¢Êà∑Á´Ø] ${msg}`);
                };

                // Â∞Ü AudioWorklet Â§ÑÁêÜÂô®‰ª£Á†Å‰Ωú‰∏∫ÂÜÖËÅîÂ≠óÁ¨¶‰∏≤Ôºå‰ª•ÈÅøÂÖçÈ¢ùÂ§ñÁöÑÊñá‰ª∂Âä†ËΩΩ
                const audioProcessorCode = `
                class PcmBufferProcessor extends AudioWorkletProcessor {
                  constructor() {
                    super();
                    this.frameSize = 960;
                    this.buffer = new Int16Array(this.frameSize);
                    this.bufferIndex = 0;
                    this.isRecording = false;
                    this.port.onmessage = (event) => {
                      if (event.data.command === 'start') this.isRecording = true;
                      else if (event.data.command === 'stop') {
                        this.isRecording = false;
                        if (this.bufferIndex > 0) {
                          const finalBuffer = this.buffer.slice(0, this.bufferIndex);
                          this.port.postMessage(finalBuffer.buffer, [finalBuffer.buffer]);
                        }
                      }
                    };
                  }
                  process(inputs) {
                    if (!this.isRecording) return true;
                    const input = inputs[0][0];
                    if (!input) return true;
                    for (let i = 0; i < input.length; i++) {
                      this.buffer[this.bufferIndex++] = Math.max(-1, Math.min(1, input[i])) * 0x7FFF;
                      if (this.bufferIndex >= this.frameSize) {
                        this.port.postMessage(this.buffer.buffer, [this.buffer.buffer]);
                        this.buffer = new Int16Array(this.frameSize);
                        this.bufferIndex = 0;
                      }
                    }
                    return true;
                  }
                }
                registerProcessor('pcm-buffer-processor', PcmBufferProcessor);
            `;

                async function start() {
                    if (audioContext) return; // Èò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
                    log("Ê≠£Âú®ÂêØÂä®...");
                    startBtn.disabled = true;

                    try {
                        const url = `ws://${window.location.host}/audio`;
                        websocket = new WebSocket(url);

                        websocket.onopen = async () => {
                            log("ËøûÊé•ÊàêÂäüÔºåÊ≠£Âú®ËØ∑Ê±ÇÈ∫¶ÂÖãÈ£é...");
                            audioContext = new (window.AudioContext ||
                                window.webkitAudioContext)({
                                sampleRate: 16000,
                            });
                            audioStream =
                                await navigator.mediaDevices.getUserMedia({
                                    audio: { sampleRate: 16000 },
                                });

                            const source =
                                audioContext.createMediaStreamSource(
                                    audioStream,
                                );

                            const blob = new Blob([audioProcessorCode], {
                                type: "application/javascript",
                            });
                            const processorUrl = URL.createObjectURL(blob);
                            await audioContext.audioWorklet.addModule(
                                processorUrl,
                            );
                            URL.revokeObjectURL(processorUrl);

                            audioWorkletNode = new AudioWorkletNode(
                                audioContext,
                                "pcm-buffer-processor",
                            );

                            // ÁõëÂê¨Êù•Ëá™Â§ÑÁêÜÂô®ÁöÑ„ÄÅÂ∑≤ÁªèÊâìÂåÖÂ•ΩÁöÑPCMÊï∞ÊçÆÂùó
                            audioWorkletNode.port.onmessage = (event) => {
                                if (
                                    websocket &&
                                    websocket.readyState === WebSocket.OPEN
                                ) {
                                    // event.data Â∞±ÊòØ‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ ArrayBuffer
                                    websocket.send(event.data);
                                }
                            };

                            source.connect(audioWorkletNode);

                            // ÂëäËØâÂ§ÑÁêÜÂô®ÂºÄÂßãÂ∑•‰Ωú
                            audioWorkletNode.port.postMessage({
                                command: "start",
                            });

                            stopBtn.disabled = false;
                            log("Ê≠£Âú®ÂΩïÈü≥...");
                        };

                        websocket.onclose = () => {
                            log("ËøûÊé•Â∑≤ÂÖ≥Èó≠");
                            cleanUp();
                        };

                        websocket.onerror = (err) => {
                            log("ËøûÊé•ÈîôËØØ");
                            console.error("WebSocket Error:", err);
                            cleanUp();
                        };
                    } catch (error) {
                        log(`ÂêØÂä®Â§±Ë¥•: ${error.message}`);
                        cleanUp();
                    }
                }

                function stop() {
                    if (!audioContext) return;
                    log("Ê≠£Âú®ÂÅúÊ≠¢...");
                    stopBtn.disabled = true;

                    // ÂëäËØâÂ§ÑÁêÜÂô®ÂÅúÊ≠¢Âπ∂ÂèëÈÄÅÊúÄÂêé‰∏Ä‰∏™Êï∞ÊçÆÂåÖ
                    if (audioWorkletNode) {
                        audioWorkletNode.port.postMessage({ command: "stop" });
                    }

                    // ÂÅúÊ≠¢È∫¶ÂÖãÈ£éËΩ®ÈÅì
                    if (audioStream) {
                        audioStream
                            .getTracks()
                            .forEach((track) => track.stop());
                    }

                    // Áªô‰∫àÊúÄÂêé‰∏Ä‰∏™Êï∞ÊçÆÂåÖÂèëÈÄÅÁöÑÊó∂Èó¥ÔºåÁÑ∂ÂêéÂÖ≥Èó≠ËøûÊé•
                    setTimeout(() => {
                        if (websocket) websocket.close();
                        if (audioContext) audioContext.close();
                        cleanUp();
                    }, 200);
                }

                function cleanUp() {
                    websocket =
                        audioContext =
                        audioStream =
                        audioWorkletNode =
                            null;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    if (statusDiv.textContent.includes("Ê≠£Âú®")) {
                        log("Á©∫Èó≤");
                    }
                }

                startBtn.addEventListener("click", start);
                stopBtn.addEventListener("click", stop);
                log("È°µÈù¢Â∑≤Âä†ËΩΩÔºåËØ∑ÂºÄÂßãÂΩïÈü≥„ÄÇ");
            });
        </script>
    </body>
</html>
